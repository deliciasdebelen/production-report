{% extends "layout.html" %}

{% block content %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<style>
    /* Styling for DataTables to match Odoo-like theme */
    table.dataTable thead th {
        background-color: var(--surface);
        color: var(--text-muted);
        border-bottom: 2px solid var(--border);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    table.dataTable tbody td {
        color: var(--text-main);
        border-bottom: 1px solid var(--border);
        padding: 0.75rem;
    }

    table.dataTable.no-footer {
        border-bottom: 1px solid var(--border);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background: var(--surface);
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--radius);
        width: 90%;
        max-width: 1000px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 1rem;
    }

    .modal-title {
        color: var(--primary);
        font-size: 1.25rem;
        margin: 0;
    }
</style>

<div style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items:center;">
    <h2 style="color: var(--primary); font-weight: 300;">Traslados en Tiempo Real</h2>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <span id="ultimaActualizacion" style="color: var(--text-muted); font-size: 0.85rem; font-style: italic;">
            Última actualización: cargando...
        </span>
    </div>
</div>

<div class="card" style="padding: 1rem;">
    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--text-muted); font-size: 0.85rem;">
            <span
                style="display: inline-block; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; margin-right: 0.5rem;"></span>
            Mostrando solo traslados <strong>NO confirmados</strong>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button onclick="detenerAutoActualizacion()" class="btn"
                style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--danger); border-color: var(--danger);">
                ⏹ Detener
            </button>
            <button onclick="iniciarAutoActualizacion()" class="btn"
                style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: var(--success); border-color: var(--success);">
                ▶ Reanudar
            </button>
        </div>
    </div>

    <table id="tablaTiempoReal" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Nro Traslado</th>
                <th>Fecha</th>
                <th>Origen</th>
                <th>Destino</th>
                <th>Estado</th>
                <th>Arts.</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Modal para detalle -->
<div id="modalDetalle" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Detalle del Traslado: <span id="modalTitulo"></span></h3>
            <button onclick="cerrarModal()"
                style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>

        <table id="tablaDetalle" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Lote</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div style="margin-top: 1.5rem; text-align: right;">
            <button onclick="cerrarModal()" class="btn"
                style="background: var(--text-muted); border-color: var(--text-muted);">
                Cerrar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script>
    let tablaTiempoReal = null;
    let tablaDetalle = null;
    let intervaloTiempoReal = null;

    $(document).ready(function () {
        // Inicializar DataTable para tiempo real
        tablaTiempoReal = $('#tablaTiempoReal').DataTable({
            "data": [],
            "columns": [
                { "data": "NumeroTraslado" },
                { "data": "Fecha" },
                { "data": "AlmacenOrigen" },
                { "data": "AlmacenDestino" },
                {
                    "data": "Confirmado",
                    "render": function (data) {
                        if (data === 'SI') {
                            return '<span style="color:var(--success); font-weight:600;">Confirmado</span>';
                        } else {
                            return '<span style="color:var(--danger); font-weight:600;">Pendiente</span>';
                        }
                    }
                },
                { "data": "CantidadArticulos" },
                {
                    "data": "NumeroTraslado",
                    "render": function (data) {
                        return `<button onclick="verDetalle('${data.trim()}')" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Ver</button>`;
                    }
                }
            ],
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json" },
            "pageLength": 25,
            "dom": "tp"
        });

        // Iniciar actualización automática
        iniciarAutoActualizacion();
    });

    function cargarDatosTiempoReal() {
        $.ajax({
            url: '/api/traslados/tiempo-real',
            success: function (data) {
                tablaTiempoReal.clear().rows.add(data).draw();
                document.getElementById('ultimaActualizacion').textContent =
                    'Última actualización: ' + new Date().toLocaleTimeString();
            },
            error: function () {
                console.error("Error al cargar traslados en tiempo real.");
            }
        });
    }

    function iniciarAutoActualizacion() {
        if (intervaloTiempoReal) clearInterval(intervaloTiempoReal);
        intervaloTiempoReal = setInterval(cargarDatosTiempoReal, 10000);
        cargarDatosTiempoReal(); // Cargar inmediatamente
    }

    function detenerAutoActualizacion() {
        if (intervaloTiempoReal) {
            clearInterval(intervaloTiempoReal);
            intervaloTiempoReal = null;
        }
    }

    function verDetalle(tras_num) {
        document.getElementById('modalTitulo').textContent = tras_num;
        $('#modalDetalle').show();

        // Destroy previous
        try {
            if ($.fn.dataTable.isDataTable('#tablaDetalle')) {
                $('#tablaDetalle').DataTable().clear().destroy();
            }
        } catch (e) {
            console.warn(e);
        }

        // Initialize with AJAX data fetch
        window.tablaDetalle = $('#tablaDetalle').DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "/api/traslados/detalle",
                "data": { tras_num: tras_num },
                "dataSrc": ""
            },
            "columns": [
                { "data": "NroLote" },
                { "data": "CodigoArticulo" },
                { "data": "DescripcionArticulo" },
                { "data": "Fecha" },
                { "data": "AlmacenOrigen" },
                { "data": "AlmacenDestino" },
                {
                    "data": "Confirmado",
                    "render": function (data) {
                        return data === 'SI' ? '<span style="color:var(--success)">SI</span>' : '<span style="color:var(--danger)">NO</span>';
                    }
                }
            ],
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json" },
            "destroy": true,
            "pageLength": 10,
            "dom": "tp"
        });
    }

    function cerrarModal() {
        $('#modalDetalle').hide();
    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target == document.getElementById('modalDetalle')) {
            cerrarModal();
        }
    }
</script>
{% endblock %}