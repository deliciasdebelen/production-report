{% extends "layout.html" %}

{% block content %}
<h1 style="margin-bottom: 1.5rem;">Reporte de Producci√≥n</h1>

<style>
    /* Premium Compact Form Styles */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        /* 12-column grid system */
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .col-span-2 {
        grid-column: span 2;
    }

    .col-span-3 {
        grid-column: span 3;
    }

    .col-span-4 {
        grid-column: span 4;
    }

    .col-span-6 {
        grid-column: span 6;
    }

    .col-span-8 {
        grid-column: span 8;
    }

    .col-span-12 {
        grid-column: span 12;
    }

    .form-group label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
        display: block;
        letter-spacing: 0.02em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        /* Reduced padding */
        font-size: 0.9rem;
        /* Slightly smaller text */
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        /* Softer corners */
        background: #f8fafc;
        transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
        background: white;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .section-title {
        font-size: 0.95rem;
        color: var(--primary);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 2rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Input addons or visual cues */
    .input-wrapper {
        position: relative;
    }

    /* Custom File Upload Styling */
    .file-input-hidden {
        display: none;
    }

    .file-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: white;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    .file-label:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: #f0f9ff;
    }

    .file-label .icon {
        font-size: 1.2rem;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .col-span-2,
        .col-span-3,
        .col-span-4,
        .col-span-6 {
            grid-column: span 1;
        }
    }
</style>

<div class="card" style="max-width: 1000px; margin: 0 auto;">
    <form id="productionForm">

        <!-- Header Section: Basic Info -->
        <div class="form-grid">
            <div class="form-group col-span-3"> <!-- Batch is small -->
                <label>Nro. Batch</label>
                <input type="number" name="batch_qty" required placeholder="0">
            </div>
            <div class="form-group col-span-3"> <!-- Date is fixed -->
                <label>Fecha</label>
                <input type="date" name="custom_created_at" value="{{ request.state.today }}" {% if user.role !=4
                    %}disabled{% endif %}>
            </div>
            <!-- Article Search needs space -->
            <div class="form-group col-span-6">
                <label>Tipo de Art√≠culo</label>
                <div style="position: relative;">
                    <input type="text" id="articleSearch" placeholder="üîç Buscar art√≠culo..." autocomplete="off">
                    <input type="hidden" name="article_type" id="articleTypeHidden" required>
                    <div id="articleResults"
                        style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-top: none; z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: Description & Units -->
        <div class="form-grid">
            <div class="form-group col-span-4">
                <label>Presentaci√≥n</label>
                <input type="text" name="presentation" id="presentationInput" required placeholder="Ej: 600G">
            </div>
            <div class="form-group col-span-4">
                <label>Unidad Base (System)</label>
                <input type="text" id="baseUnit" disabled style="background-color: #e2e8f0; color: #64748b;">
            </div>
            <div class="form-group col-span-4">
                <label>Kg Est√°ndar / Batch</label>
                <input type="text" inputmode="decimal" id="kgPerBatch" placeholder="0.00">
            </div>
        </div>

        <!-- Section: Primary Output -->
        <div class="form-grid"
            style="background: #f1f5f9; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div class="form-group col-span-4">
                <label>Total Kg Producidos</label>
                <input type="text" inputmode="decimal" name="kg_produced" id="totalKgInput" required
                    style="background-color: white; font-weight: 700; color: var(--primary);">
                <small style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; display: block;">Calculado:
                    Batches * Kg/Batch</small>
            </div>
            <div class="form-group col-span-4">
                <label>Unidades Producidas</label>
                <input type="number" name="pt_units" id="unitsInput" required style="background: white;">
            </div>
            <div class="form-group col-span-4">
                <label>Cajas Totales</label>
                <input type="text" inputmode="decimal" name="boxes" id="boxesInput" required style="background: white;">
            </div>
        </div>

        <h3 class="section-title">üì¶ Producto Terminado (Calidad)</h3>
        <div class="form-grid">
            <div class="form-group col-span-3">
                <label>Und. Laboratorio</label>
                <input type="number" name="pt_lab" placeholder="0">
            </div>
            <div class="form-group col-span-3">
                <label>Und. Quemadas</label>
                <input type="number" name="pt_burned" placeholder="0">
            </div>
            <div class="form-group col-span-6">
                <!-- Spacer or additional fields if needed -->
            </div>
        </div>

        <h3 class="section-title">‚ôªÔ∏è Materia Prima & Mermas</h3>
        <div class="form-grid">
            <div class="form-group col-span-3">
                <label>Envases Descart.</label>
                <input type="number" name="mp_containers" placeholder="0">
            </div>
            <div class="form-group col-span-3">
                <label>Tapas Limpias Desc.</label>
                <input type="number" name="mp_caps_clean" placeholder="0">
            </div>
            <div class="form-group col-span-3">
                <label>Tapas Sucias Desc.</label>
                <input type="number" name="mp_caps_dirty" placeholder="0">
            </div>
            <div class="form-group col-span-3">
            </div>

            <!-- Waste Row -->
            <div class="form-group col-span-4" style="margin-top: 0.5rem;">
                <label style="color: var(--danger);">Merma Total (Kg)</label>
                <input type="text" inputmode="decimal" name="mp_waste_kg" placeholder="0.00"
                    style="border-color: #fca5a5; background: #fef2f2;">
            </div>
            <div class="form-group col-span-8" style="margin-top: 0.5rem;">
                <label>Evidencia Visual (Foto)</label>
                <div class="custom-file-upload">
                    <input type="file" name="mp_waste_image" id="wasteImageInput" accept="image/*"
                        class="file-input-hidden">
                    <label for="wasteImageInput" class="file-label">
                        <span class="icon">üì∑</span>
                        <span id="fileName">Toca para subir foto...</span>
                    </label>
                </div>
            </div>
        </div>

        <h3 class="section-title">‚ö° Consumo R√°pido</h3>
        <div class="form-grid">
            <div class="form-group col-span-3">
                <label>Tipo Unidad</label>
                <select name="cons_type" id="consType">
                    <option value="">-- Seleccionar --</option>
                    <option value="Unidad">Unidad</option>
                    <option value="Galon">Gal√≥n</option>
                    <option value="Litro">Litro</option>
                    <option value="Kg">Kg</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group col-span-3">
                <label>Cant. Consumida</label>
                <input type="text" inputmode="decimal" name="cons_count" id="consCount" placeholder="0">
            </div>
            <div class="form-group col-span-3">
                <label>Peso x Unidad (Kg)</label>
                <input type="text" inputmode="decimal" name="cons_unit_weight" id="consUnitWeight" placeholder="0.00">
            </div>
            <div class="form-group col-span-3">
                <label>Total CR (Kg)</label>
                <input type="text" inputmode="decimal" name="cons_qty" id="consTotalWeight" readonly
                    style="background-color: #e2e8f0; font-weight: 600;">
            </div>
        </div>

        <div class="form-group" style="margin-top: 2rem;">
            <label>Notas Adicionales</label>
            <textarea name="notes" rows="2" placeholder="Observaciones importantes del turno..."></textarea>
        </div>

        <div
            style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
            <button type="button" onclick="window.open('/maintenance/report/print?type=production', '_blank')"
                class="btn"
                style="background: white; color: var(--text-main); border: 1px solid #cbd5e1; padding: 0.6rem 1.5rem; border-radius: 8px;">
                üñ® Imprimir
            </button>
            <button type="submit" class="btn"
                style="background-color: var(--primary); color: white; border: none; padding: 0.6rem 2rem; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 6px -1px var(--primary-light);">
                Guardar Reporte
            </button>
        </div>
    </form>
</div>


<script>
    // ... (Existing loadArticles logic) ...
    let articlesData = [];

    async function loadArticles() {
        const searchInput = document.getElementById('articleSearch');
        try {
            searchInput.placeholder = "Cargando datos...";
            const res = await fetch('/api/external/articles');
            if (!res.ok) throw new Error('Error');
            articlesData = await res.json();
            searchInput.placeholder = "Escriba para buscar art√≠culo...";
        } catch (e) {
            console.error('API External Error:', e);
            searchInput.placeholder = "Error cargando art√≠culos";
        }
    }

    // Progressive Search Logic
    const searchInput = document.getElementById('articleSearch');
    const resultsDiv = document.getElementById('articleResults');
    const hiddenInput = document.getElementById('articleTypeHidden');

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        if (term.length < 1) {
            resultsDiv.style.display = 'none';
            return;
        }

        const filtered = articlesData.filter(a =>
            a.description.toLowerCase().includes(term) || a.code.toLowerCase().includes(term)
        );

        if (filtered.length > 0) {
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.style.padding = '0.5rem';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.textContent = `${item.code} - ${item.description}`;
                div.onmouseover = () => div.style.background = '#f1f1f1';
                div.onmouseout = () => div.style.background = 'white';

                div.onclick = () => {
                    selectArticle(item);
                };
                resultsDiv.appendChild(div);
            });
        } else {
            resultsDiv.style.display = 'none';
        }
    });

    let currentBoxEquiv = 0;

    function selectArticle(item) {
        searchInput.value = item.description;
        hiddenInput.value = item.description;
        resultsDiv.style.display = 'none';

        // Auto-fill logic
        document.getElementById('baseUnit').value = item.unit;
        if (item.unit) {
            document.getElementById('consType').value = item.unit;
        }

        currentBoxEquiv = item.box_equiv || 0;

        // Smart Extraction for Presentation (e.g., "BOLSA 600g")
        const regex = /(\d+(?:\.|,)?\d*\s*(?:g|kg|ml|l|cc|gr|lb|oz|ton)\b)/i;
        const match = item.description.match(regex);

        const presentationInput = document.getElementById('presentationInput');
        if (match) {
            presentationInput.value = match[1].replace(/\s+/g, '').toUpperCase();
        } else {
            presentationInput.value = "";
        }

        calculateUnits();
    }

    // Kg Calculator
    const batchInput = document.querySelector('input[name="batch_qty"]');
    const kgPerBatchInput = document.getElementById('kgPerBatch');
    const totalKgInput = document.getElementById('totalKgInput');

    function parseLocaleFloat(val) {
        if (!val) return 0;
        return parseFloat(val.toString().replace(',', '.')) || 0;
    }

    function calculateTotalKg() {
        const batches = parseFloat(batchInput.value) || 0;
        const kgBatch = parseLocaleFloat(kgPerBatchInput.value);
        if (batches > 0 && kgBatch > 0) {
            totalKgInput.value = (batches * kgBatch).toFixed(2).replace('.', ',');
        }
    }

    batchInput.addEventListener('input', calculateTotalKg);
    kgPerBatchInput.addEventListener('input', calculateTotalKg);

    // Calculation Logic: Bidirectional Boxes <-> Units
    const boxesInput = document.getElementById('boxesInput');
    const unitsInput = document.getElementById('unitsInput');

    boxesInput.addEventListener('input', calculateUnits);

    function calculateUnits() {
        const boxes = parseLocaleFloat(boxesInput.value);
        if (currentBoxEquiv > 0 && boxes > 0) {
            unitsInput.value = (boxes * currentBoxEquiv).toFixed(0);
        }
    }

    unitsInput.addEventListener('input', () => {
        const units = parseFloat(unitsInput.value) || 0;
        if (currentBoxEquiv > 0) {
            boxesInput.value = (units / currentBoxEquiv).toFixed(2);
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });

    // Consumo Rapido Calculator
    const consCountInput = document.getElementById('consCount');
    const consUnitWeightInput = document.getElementById('consUnitWeight');
    const consTotalWeightInput = document.getElementById('consTotalWeight');

    function calculateConsWeight() {
        const count = parseLocaleFloat(consCountInput.value);
        const unitWeight = parseLocaleFloat(consUnitWeightInput.value);
        if (count > 0 && unitWeight > 0) {
            consTotalWeightInput.value = (count * unitWeight).toFixed(2).replace('.', ',');
        }
    }

    consCountInput.addEventListener('input', calculateConsWeight);
    consUnitWeightInput.addEventListener('input', calculateConsWeight);

    // Auto-fill Weight for Galon
    const consTypeSelect = document.getElementById('consType');
    consTypeSelect.addEventListener('change', () => {
        if (consTypeSelect.value === 'Galon') {
            consUnitWeightInput.value = "3,785";
            calculateConsWeight();
        }
    });

    loadArticles();

    // Custom File Input Logic
    const fileInput = document.getElementById('wasteImageInput');
    const fileNameSpan = document.getElementById('fileName');

    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameSpan.textContent = e.target.files[0].name;
                fileNameSpan.style.color = '#334155'; // Slate 700
                fileNameSpan.style.fontWeight = '500';
            } else {
                fileNameSpan.textContent = "Toca para subir foto...";
                fileNameSpan.style.color = 'var(--text-muted)';
                fileNameSpan.style.fontWeight = 'normal';
            }
        });
    }

    document.getElementById('productionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        // Client-side validation/formatting if needed
        // Note: FormData values are strings/blobs. The backend FastApi Form features will cast them.
        // However, we might want to ensure dots instead of commas for floats before sending?
        // Or simply trust the backend to handle standard float string if locale matches?
        // Let's replace comma with dot in formData for float fields to be safe

        const floatFields = ['kg_produced', 'boxes', 'cons_count', 'cons_unit_weight', 'cons_qty', 'mp_waste_kg'];

        for (const field of floatFields) {
            const val = formData.get(field);
            if (val && typeof val === 'string') {
                formData.set(field, val.replace(',', '.'));
            }
        }

        try {
            const response = await fetch('/api/production', {
                method: 'POST',
                body: formData // No Content-Type header (browser sets it with boundary)
            });

            if (response.ok) {
                alert('Reporte guardado exitosamente');
                form.reset();
                document.getElementById('totalKgInput').value = '';
                document.getElementById('consTotalWeight').value = '';
            } else {
                const err = await response.json();
                alert('Error al guardar reporte: ' + JSON.stringify(err.detail));
            }
        } catch (error) {
            console.error(error);
            alert('Error de conexi√≥n');
        }
    });


</script>
{% endblock %}