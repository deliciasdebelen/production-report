{% extends "layout.html" %}

{% block content %}
<h1 style="margin-bottom: 1.5rem;">Planificaci贸n de Producci贸n</h1>

<style>
    /* Premium Compact Form Styles */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .col-span-3 {
        grid-column: span 3;
    }

    .col-span-4 {
        grid-column: span 4;
    }

    .col-span-6 {
        grid-column: span 6;
    }

    .col-span-12 {
        grid-column: span 12;
    }

    .form-group label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 0.35rem;
        display: block;
        letter-spacing: 0.02em;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        transition: all 0.2s ease;
    }

    .form-group input:focus {
        background: white;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }

        .col-span-3,
        .col-span-4,
        .col-span-6 {
            grid-column: span 1;
        }
    }
</style>

<div class="card" style="max-width: 1000px; margin: 0 auto;">
    <form id="planningForm">
        <!-- Header -->
        <div class="form-grid">
            <div class="form-group col-span-4">
                <label>Fecha Planificada</label>
                <input type="date" name="date" required>
            </div>
            <div class="form-group col-span-4">
                <label>Nro de Batches</label>
                <input type="number" name="batches" required placeholder="0">
            </div>
            <div class="form-group col-span-4">
                <label>Kg Por Batch (Est谩ndar)</label>
                <input type="text" inputmode="decimal" id="kgPerBatch" placeholder="0.00">
            </div>
        </div>

        <!-- Article -->
        <div class="form-grid">
            <div class="form-group col-span-6">
                <label>Art铆culo</label>
                <div style="position: relative;">
                    <input type="text" id="articleSearch" placeholder=" Buscar art铆culo..." autocomplete="off">
                    <input type="hidden" name="article" id="articleHidden" required>
                    <div id="articleResults"
                        style="display: none; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-top: none; z-index: 1000; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px;">
                    </div>
                </div>
            </div>
            <div class="form-group col-span-6">
                <label>Presentaci贸n</label>
                <input type="text" name="presentation" id="presentationInput" required placeholder="Ej: 600G">
            </div>
        </div>

        <!-- Output Stats -->
        <div class="form-grid"
            style="background: #f1f5f9; padding: 1.5rem; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div class="form-group col-span-4">
                <label>Total Kg Planificados</label>
                <input type="text" inputmode="decimal" name="kg" id="totalKgInput" required
                    style="background-color: white; font-weight: 700; color: var(--primary);">
            </div>
            <div class="form-group col-span-4">
                <label>Unidades Esperadas</label>
                <input type="number" name="units" id="unitsInput" required style="background: white;">
            </div>
            <div class="form-group col-span-4">
                <label>Cajas Totales</label>
                <input type="text" inputmode="decimal" name="boxes" id="boxesInput" required style="background: white;">
            </div>
        </div>

        <div
            style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
            <button type="button" onclick="window.open('/maintenance/report/print?type=planning', '_blank')" class="btn"
                style="background: white; color: var(--text-main); border: 1px solid #cbd5e1; padding: 0.6rem 1.5rem; border-radius: 8px;">
                 Imprimir
            </button>
            <button type="submit" class="btn"
                style="background-color: var(--primary); color: white; border: none; padding: 0.6rem 2rem; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 6px -1px var(--primary-light);">
                Guardar Planificaci贸n
            </button>
        </div>
    </form>
</div>


<script>
    // Load Articles from Profit Plus
    let articlesData = [];
    async function loadArticles() {
        const searchInput = document.getElementById('articleSearch');
        try {
            searchInput.placeholder = "Cargando art铆culos...";
            const res = await fetch('/api/external/articles');
            if (!res.ok) throw new Error('Error fetching articles');
            articlesData = await res.json();
            searchInput.placeholder = "Buscar art铆culo...";
        } catch (e) {
            console.error(e);
            searchInput.placeholder = "Error conexi贸n";
        }
    }

    // Progressive Search Logic
    const searchInput = document.getElementById('articleSearch');
    const resultsDiv = document.getElementById('articleResults');
    const hiddenInput = document.getElementById('articleHidden');

    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        if (term.length < 1) {
            resultsDiv.style.display = 'none';
            return;
        }

        const filtered = articlesData.filter(a =>
            a.description.toLowerCase().includes(term) || a.code.toLowerCase().includes(term)
        );

        if (filtered.length > 0) {
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.style.padding = '0.5rem';
                div.style.cursor = 'pointer';
                div.style.borderBottom = '1px solid #eee';
                div.textContent = `${item.code} - ${item.description}`;
                div.onmouseover = () => div.style.background = '#f1f1f1';
                div.onmouseout = () => div.style.background = 'white';

                div.onclick = () => {
                    selectArticle(item);
                };
                resultsDiv.appendChild(div);
            });
        } else {
            resultsDiv.style.display = 'none';
        }
    });

    let currentBoxEquiv = 0;

    function selectArticle(item) {
        searchInput.value = item.description;
        hiddenInput.value = item.description;
        resultsDiv.style.display = 'none';

        // Store equivalence
        currentBoxEquiv = item.box_equiv || 0;

        // Smart Extraction for Presentation
        const regex = /(\d+(?:\.|,)?\d*\s*(?:g|kg|ml|l|cc|gr|lb|oz|ton)\b)/i;
        const match = item.description.match(regex);

        const presentationInput = document.getElementById('presentationInput');
        if (match) {
            presentationInput.value = match[1].replace(/\s+/g, '').toUpperCase();
        } else {
            presentationInput.value = "";
        }

        calculateUnits();
    }

    // Kg Calculator
    const batchInput = document.querySelector('input[name="batches"]');
    const kgPerBatchInput = document.getElementById('kgPerBatch');
    const totalKgInput = document.getElementById('totalKgInput');

    function parseLocaleFloat(val) {
        if (!val) return 0;
        // Replace comma with dot if present
        return parseFloat(val.toString().replace(',', '.')) || 0;
    }

    function calculateTotalKg() {
        const batches = parseFloat(batchInput.value) || 0;
        const kgBatch = parseLocaleFloat(kgPerBatchInput.value);
        if (batches > 0 && kgBatch > 0) {
            totalKgInput.value = (batches * kgBatch).toFixed(2).replace('.', ','); // Display with comma for consistency?
            // Actually standard HTML value usage prefers dot, but user expects comma. 
            // Since we use type="text", we can show comma.
        }
    }

    batchInput.addEventListener('input', calculateTotalKg);
    kgPerBatchInput.addEventListener('input', calculateTotalKg);

    // Calculation Logic: Bidirectional Boxes <-> Units
    const boxesInput = document.getElementById('boxesInput');
    const unitsInput = document.getElementById('unitsInput');

    boxesInput.addEventListener('input', calculateUnits);

    function calculateUnits() {
        // Boxes -> Units
        const boxes = parseLocaleFloat(boxesInput.value);
        if (currentBoxEquiv > 0 && boxes > 0) {
            unitsInput.value = (boxes * currentBoxEquiv).toFixed(0);
        }
    }

    // Units -> Boxes (Reverse Calc)
    unitsInput.addEventListener('input', () => {
        const units = parseFloat(unitsInput.value) || 0;
        if (currentBoxEquiv > 0) {
            // Show with comma if user prefers?
            // Let's use standard dot for value, but maybe the user keeps typing comma manually.
            boxesInput.value = (units / currentBoxEquiv).toFixed(2);
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.style.display = 'none';
        }
    });

    loadArticles();

    document.getElementById('planningForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Sanitization
        try {
            data.kg = parseLocaleFloat(data.kg);
            data.boxes = parseLocaleFloat(data.boxes);
            data.batches = parseInt(data.batches) || 0;
            data.units = parseInt(data.units) || 0;
        } catch (err) {
            alert("Error en formato de n煤meros");
            return;
        }

        const response = await fetch('/api/planning', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert('Planificaci贸n guardada exitosamente');
            e.target.reset();
        } else {
            const err = await response.json();
            if (response.status === 403) {
                alert('Error: ' + err.detail);
            } else {
                console.error(err);
                alert('Error al guardar: ' + JSON.stringify(err.detail));
            }
        }
    });


</script>
{% endblock %}