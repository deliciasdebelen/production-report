{% extends "layout.html" %}

{% block content %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
<style>
    /* Styling for DataTables to match Odoo-like theme */
    table.dataTable thead th {
        background-color: var(--surface);
        color: var(--text-muted);
        border-bottom: 2px solid var(--border);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
    }

    table.dataTable tbody td {
        color: var(--text-main);
        border-bottom: 1px solid var(--border);
        padding: 0.75rem;
    }

    table.dataTable.no-footer {
        border-bottom: 1px solid var(--border);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-content {
        background: var(--surface);
        margin: 5% auto;
        padding: 2rem;
        border-radius: var(--radius);
        width: 90%;
        max-width: 1000px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 1rem;
    }

    .modal-title {
        color: var(--primary);
        font-size: 1.25rem;
        margin: 0;
    }
</style>

<div style="margin-bottom: 1.5rem; display:flex; justify-content:space-between; align-items:center;">
    <h2 style="color: var(--primary); font-weight: 300;">Traslados entre Almacenes</h2>
</div>

<!-- Filtros -->
<div class="card">
    <div
        style="margin-bottom: 1rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.85rem;">
        Filtros de Búsqueda</div>

    <div class="grid-3">
        <div class="form-group">
            <label for="alm_dest">Almacén Destino</label>
            <select id="alm_dest">
                <option value="">-- Todos --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="fecha_desde">Fecha Desde</label>
            <input type="date" id="fecha_desde">
        </div>
        <div class="form-group">
            <label for="fecha_hasta">Fecha Hasta</label>
            <input type="date" id="fecha_hasta">
        </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
        <button onclick="limpiarFiltros()" class="btn"
            style="background: white; color: var(--text-main); border-color: var(--border);">
            Limpiar
        </button>
        <button onclick="cargarCabecera()" class="btn">
            Buscar
        </button>
    </div>
</div>

<!-- Tabla de cabecera -->
<div class="card" style="padding: 1rem;">
    <!-- Botones de filtro por Confirmado (Tabs Style) -->
    <div style="margin-bottom: 1rem; border-bottom: 1px solid var(--border); display: flex; gap: 1rem;">
        <button onclick="filtrarConfirmado('')" class="filter-tab active"
            style="background:none; border:none; padding: 0.5rem 1rem; border-bottom: 2px solid var(--primary); color: var(--primary); font-weight:600; cursor:pointer;">Todos</button>
        <button onclick="filtrarConfirmado('NO')" class="filter-tab"
            style="background:none; border:none; padding: 0.5rem 1rem; color: var(--text-muted); cursor:pointer;">Pendientes
            (No Conf.)</button>
        <button onclick="filtrarConfirmado('SI')" class="filter-tab"
            style="background:none; border:none; padding: 0.5rem 1rem; color: var(--text-muted); cursor:pointer;">Confirmados</button>
    </div>

    <table id="tablaCabecera" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Nro Traslado</th>
                <th>Fecha</th>
                <th>Origen</th>
                <th>Destino</th>
                <th>Estado</th>
                <th>Arts.</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Modal para detalle -->
<div id="modalDetalle" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Detalle del Traslado: <span id="modalTitulo"></span></h3>
            <button onclick="cerrarModal()"
                style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-muted);">&times;</button>
        </div>

        <div id="modalSpinner" style="display:none; text-align:center; padding: 2rem; color: var(--primary);">
            Cargando detalle...
        </div>

        <table id="tablaDetalle" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Lote</th>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div style="margin-top: 1.5rem; text-align: right;">
            <button onclick="cerrarModal()" class="btn"
                style="background: var(--text-muted); border-color: var(--text-muted);">
                Cerrar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script>
    let tablaCabecera = null;
    let tablaDetalle = null;

    $(document).ready(function () {
        // Inicializar DataTable para cabecera
        tablaCabecera = $('#tablaCabecera').DataTable({
            "data": [],
            "columns": [
                { "data": "NumeroTraslado" },
                { "data": "Fecha" },
                { "data": "AlmacenOrigen" },
                { "data": "AlmacenDestino" },
                {
                    "data": "Confirmado",
                    "render": function (data) {
                        if (data === 'SI') {
                            return '<span style="color:var(--success); font-weight:600;">Confirmado</span>';
                        } else {
                            return '<span style="color:var(--danger); font-weight:600;">Pendiente</span>';
                        }
                    }
                },
                { "data": "CantidadArticulos" },
                {
                    "data": "NumeroTraslado",
                    "render": function (data) {
                        return `<button onclick="verDetalle('${data}')" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Ver</button>`;
                    }
                }
            ],
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json" },
            "pageLength": 25,
            "dom": "tp" // Simple layout
        });

        // Tab Handling
        $('.filter-tab').click(function () {
            $('.filter-tab').css({ 'border-bottom': 'none', 'color': 'var(--text-muted)' });
            $(this).css({ 'border-bottom': '2px solid var(--primary)', 'color': 'var(--primary)' });
        });

        // Cargar almacenes
        cargarAlmacenes();
    });

    function cargarAlmacenes() {
        $.ajax({
            url: '/api/traslados/almacenes', /* Adjusted API URL to be routed via traslados router */
            success: function (data) {
                const select = document.getElementById('alm_dest');
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.codigo;
                    option.textContent = `${item.codigo} - ${item.nombre}`;
                    select.appendChild(option);
                });
            },
            error: function () {
                // alert("Error al cargar los almacenes.");
                console.error("Error al cargar almacenes");
            }
        });
    }

    function cargarCabecera() {
        const alm_dest = document.getElementById('alm_dest').value || '';
        const fecha_desde = document.getElementById('fecha_desde').value || '';
        const fecha_hasta = document.getElementById('fecha_hasta').value || '';

        // Allow search without filters if user wants all? Usually heavy. 
        // Let's require at least one or strict warnings.
        // The original code required one.
        if (!alm_dest && !fecha_desde && !fecha_hasta) {
            alert("Ingrese al menos un filtro.");
            return;
        }

        $.ajax({
            url: '/api/traslados/cabecera',
            data: { alm_dest, fecha_desde, fecha_hasta },
            success: function (data) {
                tablaCabecera.clear().rows.add(data).draw();
            },
            error: function () {
                alert("Error al cargar la cabecera.");
            }
        });
    }

    function limpiarFiltros() {
        document.getElementById('alm_dest').value = '';
        document.getElementById('fecha_desde').value = '';
        document.getElementById('fecha_hasta').value = '';
        tablaCabecera.clear().draw();
        // Reset active tab to 'Todos'
        $('.filter-tab').css({ 'border-bottom': 'none', 'color': 'var(--text-muted)' });
        $('.filter-tab:first').css({ 'border-bottom': '2px solid var(--primary)', 'color': 'var(--primary)' });
    }

    function filtrarConfirmado(valor) {
        tablaCabecera.column(4).search(valor).draw();
    }

    function verDetalle(tras_num) {
        tras_num = String(tras_num || '').trim();
        document.getElementById('modalTitulo').textContent = tras_num;
        $('#modalDetalle').show();

        // Mostrar spinner
        const spinner = document.getElementById('modalSpinner');
        spinner.style.display = 'block';

        // Destroy previous
        try {
            if ($.fn.dataTable.isDataTable('#tablaDetalle')) {
                $('#tablaDetalle').DataTable().clear().destroy();
            }
        } catch (e) {
            console.warn(e);
        }
        $('#tablaDetalle tbody').empty();

        $.ajax({
            url: '/api/traslados/detalle',
            method: 'GET',
            dataType: 'json',
            cache: false,
            data: { tras_num: tras_num },
            success: function (data) {
                spinner.style.display = 'none';

                tablaDetalle = $('#tablaDetalle').DataTable({
                    data: data,
                    "columns": [
                        { "data": "NroLote" },
                        { "data": "Fecha" },
                        { "data": "AlmacenOrigen" },
                        { "data": "AlmacenDestino" },
                        { "data": "CodigoArticulo" },
                        { "data": "DescripcionArticulo" },
                        {
                            "data": "Confirmado",
                            "render": function (data) {
                                return data === 'SI' ? '<span style="color:var(--success)">SI</span>' : '<span style="color:var(--danger)">NO</span>';
                            }
                        }
                    ],
                    "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json" },
                    "destroy": true,
                    "pageLength": 10,
                    "dom": "tp"
                });
            },
            error: function () {
                spinner.style.display = 'none';
                $('#tablaDetalle tbody').html('<tr><td colspan="7" style="padding:12px; text-align:center; color:var(--danger);">Error al cargar detalle (ver consola).</td></tr>');
                console.error('Error al cargar /api/traslados/detalle');
            }
        });
    }

    function cerrarModal() {
        $('#modalDetalle').hide();
        if (window.tablaDetalle) window.tablaDetalle.destroy();
    }

    // Close modal on outside click
    window.onclick = function (event) {
        if (event.target == document.getElementById('modalDetalle')) {
            cerrarModal();
        }
    }
</script>
{% endblock %}